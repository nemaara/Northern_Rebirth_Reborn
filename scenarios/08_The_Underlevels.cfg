#textdomain wesnoth-nrr

#define NRR_S08_STATUS_UPDATE_MSG
_"Unsealing Runes Found: $runes_activated
Rune One activated: $rune_one
Rune Two activated: $rune_two
Rune Three activated: $rune_three"
#enddef

#define NRR_S08_STATUS_UPDATE_MSG2
_"Enemy Leaders defeated: $enemies_defeated
Important Prisoners rescued: $vip_prisoners_rescued
Underlevels Boss Defeated: $boss_defeated"
#enddef

[scenario]
    id=08_The_Underlevels
    name= _ "The Underlevels"
    map_file=08_The_Underlevels.map
    {TURNS 65 60 55}
    next_scenario=09_Pandemonium
    victory_when_enemies_defeated=no
    {XP_MODIFIER_NRR}
    {NRR_LOAD_RESOURCES}
    {NRR_ENCHANTING_SYSTEM}
    [load_resource]
        id=nrr_rune_info_help
    [/load_resource]

    {UNDERGROUND}
    {DEFAULT_MUSIC_PLAYLIST}

    [side]
        side=1
        controller=human
        {CHARACTER_STATS_TALLIN}
        {FLAG_VARIANT knalgan}
        team_name="player"
        user_team_name= _ "Knalgan Alliance"
        shroud=yes
        fog=no
        share_vision=all
        {GOLD 240 220 200}
        {INCOME 2 2 1}
        village_gold=1
        village_support={ON_DIFFICULTY 4 3 3}
        recruit={KNALGAN_ALLIANCE_RECRUIT_LIST_FULL}
    [/side]

    # Kal Kartha side
    # side for boss unit
    [side]
        side=2
        controller=ai

        # boss side
        {NO_RECRUITMENT}

        {NO_ECONOMY}
        {HIDDEN_TEAM}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        no_leader=yes

        {NEUTRAL_AI_PARAMS}
    [/side]

    [side]
        side=3
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWARVES_VETERANS}

        gold=0 # Will change when the side is activated
        {INCOME 4 6 8}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        id=Dufon
        random_traits=yes
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf4.png~RIGHT()
        canrecruit=yes

        facing=nw

        # dwarves are neutral alignment lol
        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    # please stop spamming these
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Masked Thunderguard" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Masked Thunderer" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Masked Fighter" {ON_DIFFICULTY 3 3 4}}

    [side]
        side=4
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWARVES_VETERANS}

        gold=0 # Will change when the side is activated
        {INCOME 6 9 12}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        random_traits=yes
        id=Aragoth
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf2.png~RIGHT()
        canrecruit=yes

        facing=sw

        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Thunderguard" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Thunderer" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Fighter" {ON_DIFFICULTY 3 3 4}}

    [side]
        side=5
        controller=ai

        recruit={KAL_KARTHA_MASKED_DWARVES_VETERANS}

        gold=0 # Will change when the side is activated
        {INCOME 6 9 12}

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        type=Dwarvish Masked Lord
        id=Dranath
        random_traits=yes
        name= _ "Masked Dwarf"
        profile=portraits/maskeddwarf3.webp~RIGHT()
        canrecruit=yes

        facing=nw

        {NEUTRAL_AI_PARAMS}

        [ai]
            {NO_SCOUTS}
            recruitment_pattern=fighter,fighter,mixed fighter
        [/ai]
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Dwarvish Masked Thunderguard" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Dwarvish Masked Thunderer" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Dwarvish Masked Fighter" {ON_DIFFICULTY 3 3 4}}

    # side for spawned enemy units
    [side]
        side=6
        controller=ai
        no_leader=yes

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Kal Kartha"

        shroud=yes
        fog=yes
        share_vision=none

        {NO_ECONOMY}
        # you dont need to see this side
        {HIDDEN_TEAM}
        {NO_RECRUITMENT}

        {NEUTRAL_AI_PARAMS}
    [/side]

    # side for prisoners
    [side]
        side=7
        controller=ai
        no_leader=yes

        {FLAG_VARIANT6 ragged}
        team_name="player"
        user_team_name= _ "Knalgan Alliance"
        color=white

        shroud=yes
        fog=yes
        share_vision=none

        {NO_ECONOMY}
        {HIDDEN_TEAM}
        {NO_RECRUITMENT}

        {NEUTRAL_AI_PARAMS}
    [/side]

    # Scenery
    {PLACE_IMAGE "scenery/rune3.png" 38 21}
    {PLACE_IMAGE "scenery/rune3.png" 38 23}
    {PLACE_IMAGE "scenery/rune3.png" 46 6}
    {PLACE_IMAGE "scenery/rune3.png" 44 36}
    {PLACE_IMAGE "scenery/rune3.png"  6 12}
    {PLACE_IMAGE "scenery/rune3.png" 38 22}

    {PLACE_IMAGE "scenery/rune4.png" 10  8}
    {PLACE_IMAGE "scenery/rune4.png" 25 22}
    {PLACE_IMAGE "scenery/rune4.png" 42  3}
    {PLACE_IMAGE "scenery/rune4.png" 30 19}
    {PLACE_IMAGE "scenery/rune4.png" 38 36}
    {PLACE_IMAGE "scenery/rune4.png" 28 23}

    {PLACE_IMAGE "scenery/bookshelf-less-full.png" 3 4}
    {PLACE_IMAGE "scenery/bookshelf-broken.png" 5 3}
    {PLACE_IMAGE "scenery/bookshelf-full.png" 4 3}
    {PLACE_IMAGE "scenery/barrel1.png" 6 2}
    {PLACE_IMAGE "scenery/booksheld-fullSW.png" 7 3}

    {PLACE_IMAGE "items/armour.png" 8 3}
    {PLACE_IMAGE "items/axe-2.png" 4 4}
    {PLACE_IMAGE "items/anvil.png" 4 5}
    {PLACE_IMAGE "items/barrel2.png" 5 6}

    {PLACE_IMAGE "items/box.png" 5 4}
    {PLACE_IMAGE "items/box.png" 7 5}
    
    {PLACE_IMAGE "items/bones.png" 19 5}
    {PLACE_IMAGE "items/bones.png" 25 5}

    {PLACE_IMAGE "items/chest.png" 48 13}
    {PLACE_IMAGE "items/chest.png" 12 29}

    # Starting villages
    {STARTING_VILLAGES 1 4}
    {STARTING_VILLAGES 2 9}
    {STARTING_VILLAGES 3 5}
    {STARTING_VILLAGES_AREA 3 23 27 4}
    {STARTING_VILLAGES_AREA 3 35 28 1}
    {STARTING_VILLAGES_AREA 3 23 13 4}
    {STARTING_VILLAGES 4 6}
    {STARTING_VILLAGES 5 6}

    # prestart
    [event]
        name=prestart

        # recall heroes
        {RECALL "Aiglondur"}
        {RECALL_LOYALS}
        # recall an extra
        {KNALGAN_ALLIANCE_RECALL_LAND_BASED}

        {MODIFY_UNIT (side=1) facing se}

        # make atmosphere omnious
        {COLOR_ADJUST -25 -25 -25}

        # define vars
        {VARIABLE runes_activated 0}
        {VARIABLE rune_one no}
        {VARIABLE rune_two no}
        {VARIABLE rune_three no}
        {VARIABLE key_read no}
        {VARIABLE show_status no}

        # three conditions to meet here
        {VARIABLE enemies_defeated no}
        {VARIABLE vip_prisoners_rescued no}
        {VARIABLE boss_defeated no}

        # define objectives
        [objectives]
            side=1
            silent=no
            [objective]
                description= _ "Investigate the Underlevels"
                condition="win"
            [/objective]
            [objective]
                description= _ "Death of Tallin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Aiglondur"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Angras"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [note]
                description= _ "Right-Click Tallin to view Enchanting Help"
            [/note]
            [note]
                description= _ "Right-Click Angras to view Rune Descriptions"
            [/note]
            [note]
                description= _ "Avoid attacking Shrooms"
            [/note]

            # update player on each condition completed
            [note]
                description= _ "Enemy Leaders have been defeated"
                [show_if]
                    {VARIABLE_CONDITIONAL enemies_defeated equals yes}
                [/show_if]
            [/note]
            [note]
                description= _ "Eryssa and her sister have been rescued"
                [show_if]
                    {VARIABLE_CONDITIONAL vip_prisoners_rescued equals yes}
                [/show_if]
            [/note]
            [note]
                description= _ "You have destroyed the Underlevels boss"
                [show_if]
                    {VARIABLE_CONDITIONAL boss_defeated equals yes}
                [/show_if]
            [/note]

            [gold_carryover]
                carryover_percentage=40
                bonus=no
            [/gold_carryover]
        [/objectives]

        # spawn masked dwarven guards
        {MASKED_DWARF 6 "Dwarvish Masked Stalwart" 23 20}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 24 19}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 24 20}

        {MASKED_DWARF 6 "Dwarvish Masked Stalwart" 28 26}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 28 25}
        {MASKED_DWARF 6 "Dwarvish Masked Thunderguard" 27 26}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 30 11}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 33 12}

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 29 31}
        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 25 32}

        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 14 3}
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 18 4}

        #ifdef EASY
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 18 4}
        #else
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 15 5}
        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 17 3}
        #endif

        {MASKED_DWARF 6 "Dwarvish Masked Sentinel" 10  8}

        {MASKED_DWARF 6 "Dwarvish Masked Guardsman" 23  8}

        {GENERIC_UNIT 6 "Abomination" 12 30}
        {GENERIC_UNIT 6 "Abomination" 14 31}
        {GENERIC_UNIT 6 "Abomination" 18 28}
        {GENERIC_UNIT 6 "Abomination" 20 30}

        {GENERIC_UNIT 6 "Flesh Golem" 15 30}

        [micro_ai]
            side=6
            ai_type=lurkers
            action=add

            [filter]
                type=Abomination,Flesh Golem
            [/filter]
            [filter_location]
                terrain=U*
            [/filter_location]
            [filter_location_wander]
                terrain=U*
            [/filter_location_wander]
        [/micro_ai]

        # shrooms
        # 50% level 1
        # 30% level 2
        # 20% level 3
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 9 30}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 13 33}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 22 30}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 21 27}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 24 29}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 36 38}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Shroom") 39 33}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 28 36}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 34 29}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 35 20}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 34 16}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 4 21}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom")  9  9}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 12  5}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 49 12}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 50 13}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 41 15}
        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 42 16}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Shroom") 42 23}

        {RANDOM_SPAWN 6 ("Shroom,Shroom,Elder Shroom,Ancient Shroom,Elder Shroom,Shroom") 46 20}

        {GENERIC_UNIT 6 "Dwarvish Masked Sentinel" 48 20}
        [+unit]
            name= _ "Masked Dwarf"
            ai_special=guardian
        [/unit]
        {GENERIC_UNIT 6 "Dwarvish Masked Sentinel" 48 24}
        [+unit]
            name= _ "Masked Dwarf"
            ai_special=guardian
        [/unit]

        {GENERIC_UNIT 6 "Clockwork Golem" 51 19}{GUARDIAN}
        {GENERIC_UNIT 6 "Clockwork Golem" 52 18}{GUARDIAN}

        {GENERIC_UNIT 6 "Clockwork Golem" 51 26}{GUARDIAN}
        {GENERIC_UNIT 6 "Clockwork Golem" 52 26}{GUARDIAN}

        {GENERIC_UNIT 6 "Clockwork Golem" 53 20}{GUARDIAN}
        {GENERIC_UNIT 6 "Clockwork Golem" 53 25}{GUARDIAN}

        {GENERIC_UNIT 6 "Clockwork Golem" 54 21}{GUARDIAN}
        {GENERIC_UNIT 6 "Clockwork Golem" 54 23}{GUARDIAN}

        {GENERIC_UNIT 6 "Clockwork Golem" 56 19}{GUARDIAN}
        {GENERIC_UNIT 6 "Clockwork Golem" 56 25}{GUARDIAN}

        [unit]
            side=6
            type=Dwarvish Masked Berserker
            id=library_guard
            name= _ "Masked Dwarf"
            x,y=5,4
            random_traits=yes
        [/unit]

        {ZONE_GUARDIAN_MAI 6 add (
            [filter]
                side=6
            [/filter]
        ) (
            [filter_location]
                x=  3,  4,  5,  6,  7,  8
                y=4-5,3-5,3-6,2-5,3-5,3-4
            [/filter_location]
        ) ()}

        # spawn prisoners
        # can be human/elf/dwarf/orc/drake/goblin/troll/saurian
        # anything that can be considered a dirtgrubber

        # spawn Eryssa and Elenia
        [unit]
            side=7
            x,y=12,11
            # make it look like they were tortured
            hitpoints={ON_DIFFICULTY 12 8 6}
            {IS_HERO}
            {CHARACTER_STATS_ERYSSA}
        [/unit]

        [unit]
            side=7
            x,y=14,10
            # make it look like they were tortured
            hitpoints={ON_DIFFICULTY 12 8 6}
            {CHARACTER_STATS_ELENIA}
        [/unit]

        # random elves
        {RANDOM_SPAWN 7 ("Elvish Fighter,Elvish Archer,Elvish Shaman") 18 10}
        {RANDOM_SPAWN 7 ("Elvish Fighter,Elvish Archer,Elvish Shaman") 26 5}

        # northerners prisoners
        {RANDOM_SPAWN 7 ("Orcish Grunt,Orcish Archer,Orcish Assassin,Goblin Impaler, Goblin Rouser,Troll Whelp") 40 28}
        {RANDOM_SPAWN 7 ("Orcish Grunt,Orcish Archer,Orcish Assassin,Goblin Impaler,Goblin Rouser,Troll Whelp") 46 30}

        # knalgan prisoners
        # these are the only ones who will flip to your side
        {RANDOM_SPAWN 7 ("Outlaw,Rogue,Trapper,Outlaw")  9 26}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 13 25}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL})  8 32}

        {RANDOM_SPAWN 7 ("Outlaw,Rogue,Trapper,Outlaw") 16 35}
        {RANDOM_SPAWN 7 ({KNALGAN_ALLIANCE_RECRUIT_LIST}) 21 34}

        # add micro_AI (if needed)

        [unit]
            side=2
            x,y=58,22
            {IS_HERO}
            # unique boss type for this scenario
            type=Clockwork Knight
            id=clockwork_knight_boss
            # short for Zeta Lambda Epsilon Xemma
            name=_"Project ZLEX"
            [modifications]
                {TRAIT_ELITE}
                [object]
                    id=boss_buff_zlex
                    silent=yes
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_LEADERSHIP}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [micro_ai]
            side=2
            ai_type=bloodlust
            action=add
            [filter]
                id=clockwork_knight_boss
            [/filter]
            [filter_location]
                x=   51,   52,   53,   54,   55,   56,   57
                y=19-26,18-26,18-27,18-26,18-27,18-25,20-25
            [/filter_location]
        [/micro_ai]

        # minions
        {GENERIC_UNIT 2 "Clockwork Armoured Golem" 50 21}
        {GENERIC_UNIT 2 "Clockwork Armoured Golem" 50 23}

        {GENERIC_UNIT 2 "Clockwork Berserker" 52 21}
        {GENERIC_UNIT 2 "Clockwork Berserker" 52 23}

        {GENERIC_UNIT 2 "Clockwork Golem" 56 21}
        {GENERIC_UNIT 2 "Clockwork Golem" 56 23}

        {MINIONS_MICRO_AI 2 add (
            [filter]
                id=clockwork_knight_boss
            [/filter]
        ) (
            [filter_second]
                type=Clockwork Armoured Golem,Clockwork Golem,Clockwork Berserker
            [/filter_second]
        ) 56000 (
            messenger_death_chance=0.0
            enemy_death_chance=0.5
            # had to add these here or else AI would have a seizure
            waypoint_x=1
            waypoint_y=1
        )}

        # aesthetics
        {LAVA_OUTBURST 11 24}
        {LAVA_OUTBURST 19 35}
        {LAVA_OUTBURST  8 34}
        {LAVA_OUTBURST  6 30}
        {LAVA_OUTBURST 13 36}

        {LAVA_OUTBURST 25 37}
        {LAVA_OUTBURST 56 28}
        {LAVA_OUTBURST 58 18}

        {LAVA_OUTBURST 51 10}
        {LAVA_OUTBURST 20  2}

        # micro AI since AI decides to spawn Thunderers
        [micro_ai]
            side=3
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=recruit_random
            action=add
            skip_low_gold_recruiting=yes
        [/micro_ai]
    [/event]

    # Hidden events
    # copied code from the original THoT

    # Small unit hitpoint bonuses
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=19,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Someone died here."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=25,5
        [/filter]

        [message]
            speaker=unit
            message= _ "Poor guy didn’t make it."
        [/message]

        # Secret easter egg bonus
        # Give a unit 3 extra hp

        [object]
            [filter]
                x,y=$x1,$y1
            [/filter]
            duration=forever
            silent=yes
            [effect]
                apply_to=hitpoints
                increase_total=3
                increase=3
            [/effect]
        [/object]
    [/event]

    # Gold
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=48,13
        [/filter]

        [message]
            speaker=unit
            message= _ "There’s some gold in here!"
        [/message]

        [gold]
            side=1
            amount={ON_DIFFICULTY 50 40 30}
        [/gold]
        {PLACE_IMAGE "items/chest-open.png" 48 13}
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=12,29
        [/filter]

        [message]
            speaker=unit
            message= _ "I found some gold!"
        [/message]

        [gold]
            side=1
            amount={ON_DIFFICULTY 50 40 30}
        [/gold]
        {PLACE_IMAGE "items/chest-open.png" 12 29}
    [/event]

    # sighted events
    # copied from orignal THoT

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=unit
            message= _ "The dirtgrubber-friends have come! Slay them all!"
        [/message]

        # Activate side 3
        [gold]
            side=3
            amount={ON_DIFFICULTY 30 45 60}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Dufon
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dufon
            message= _ "You shall never pass through here! The doors I guard are sealed by the power of the Hammer itself."
        [/message]

        [message]
            speaker=second_unit
            message= _ "You won’t stop us!"
        [/message]

        [gold]
            side=3
            amount={ON_DIFFICULTY 40 55 70}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Aragoth
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Aragoth
            message= _ "Your path forward ends here!"
        [/message]

        # Give side 4 some gold
        [gold]
            side=4
            amount={ON_DIFFICULTY 60 80 100}
        [/gold]
    [/event]

    [event]
        name=sighted
        [filter]
            id=Dranath
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Dranath
            message= _ "The dirtgrubbers have come! Stop their advance!"
        [/message]

        # Give side 5 some gold
        [gold]
            side=5
            amount={ON_DIFFICULTY 60 80 100}
        [/gold]
    [/event]

    # gate events
    # starting gate
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=16,17
            y=18,18
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angras
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "The gates are locked. I will have to break them open by force!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The gates are locked!"
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Force them open!"
                [/message]

                [message]
                    speaker=unit
                    message= _ "Yes, sir!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x=18,17
            y=18,19
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Angras
            message= _ "Let us proceed onward."
        [/message]
    [/event]

    # gate to first rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=42,5
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Aiglondur
            [/variable]
            [or]
                [variable]
                    name=unit.id
                    equals=Angras
                [/variable]
            [/or]
            [then]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door. I shall break it down!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "There’s something behind this door."
                [/message]

                [message]
                    speaker=Aiglondur
                    message= _ "Break it down!"
                [/message]
            [/else]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=43,6
            terrain=Ur^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # gate to second rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=40,37
        [/filter]

        [message]
            speaker=unit
            message= _ "It looks like there is a rune behind this gate!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=41,37
            terrain=Ur^Pr\o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # gate to third rune
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=9,10
        [/filter]

        [message]
            speaker=unit
            message= _ "It looks like there is a rune behind this gate!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x,y=8,10
            terrain=Ur^Pr\o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]
    [/event]

    # trinity runic gate event set
    # rune one
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=46,6
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL rune_one equals no}
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "This must be one of the runic keys!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=petrified.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        {PLACE_IMAGE "scenery/rune3-glow.png" 38 21}
        {PLACE_IMAGE "scenery/rune3-glow.png" 46 6}

        [delay]
            time=1000
        [/delay]

        # Activate the rune
        {VARIABLE_OP runes_activated add 1}
        {VARIABLE rune_one yes}

        {PLACE_IMAGE "scenery/rune4-glow.png" 42  3}
        {PLACE_IMAGE "scenery/rune4-glow.png" 30 19}


        [hint_message]
            caption= _ "Scenario Progression:"
            message= {NRR_S08_STATUS_UPDATE_MSG}
        [/hint_message]

        # Check if both runes are activated or not
        [if]
            [variable]
                name=runes_activated
                equals=3
            [/variable]
            [then]
                [fire_event]
                    name=runes_found
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Aiglondur
                    message= _ "We still need to find more!"
                [/message]

                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # rune two
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=44,36
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL rune_two equals no}
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "This must be one of the runic keys!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=petrified.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        {PLACE_IMAGE "scenery/rune3-glow.png" 38 23}
        {PLACE_IMAGE "scenery/rune3-glow.png" 38 36}

        [delay]
            time=1000
        [/delay]

        # Activate the rune
        {VARIABLE_OP runes_activated add 1}
        {VARIABLE rune_two yes}

        {PLACE_IMAGE "scenery/rune4-glow.png" 38 36}
        {PLACE_IMAGE "scenery/rune4-glow.png" 28 23}

        [hint_message]
            caption= _ "Scenario Progression:"
            message= {NRR_S08_STATUS_UPDATE_MSG}
        [/hint_message]

        # Check if both runes are activated or not
        [if]
            [variable]
                name=runes_activated
                equals=3
            [/variable]
            [then]
                [fire_event]
                    name=runes_found
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Aiglondur
                    message= _ "We still need to find more!"
                [/message]

                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # rune three
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=6,12
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL rune_three equals no}
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "This must be one of the runic keys!"
        [/message]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=petrified.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        {PLACE_IMAGE "scenery/rune3-glow.png" 6 12}
        {PLACE_IMAGE "scenery/rune3-glow.png" 38 22}

        [delay]
            time=1000
        [/delay]

        # Activate the rune
        {VARIABLE_OP runes_activated add 1}
        {VARIABLE rune_three yes}

        {PLACE_IMAGE "scenery/rune4-glow.png" 10  8}
        {PLACE_IMAGE "scenery/rune4-glow.png" 25 22}

        [hint_message]
            caption= _ "Scenario Progression:"
            message= {NRR_S08_STATUS_UPDATE_MSG}
        [/hint_message]

        # Check if both runes are activated or not
        [if]
            [variable]
                name=runes_activated
                equals=3
            [/variable]
            [then]
                [fire_event]
                    name=runes_found
                [/fire_event]
            [/then]
            [else]
                [message]
                    speaker=Aiglondur
                    message= _ "We still need to find more!"
                [/message]

                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # if all three done then
    [event]
        id=underlevels_stage_two
        name=runes_found

        first_time_only=yes

        [message]
            speaker=Angras
            message= _ "The keys have been found. The door should open..."
        [/message]

        {SCROLL_TO 38 22}

        [delay]
            time=1000
        [/delay]

        [sound]
            name=rumble.ogg
        [/sound]

        [delay]
            time=500
        [/delay]

        [sound]
            name=dragonstick.ogg
        [/sound]

        [delay]
            time=500
        [/delay]

        [terrain]
            x=39,40
            y=23,23
            terrain=Uu
        [/terrain]
        [terrain]
            x=40,41
            y=22,23
            terrain=Ur
        [/terrain]
        [terrain]
            x=39,40
            y=22,21
            terrain=Ur^Es
        [/terrain]
        [terrain]
            x,y=41,22
            terrain=Uu^Emf
        [/terrain]
        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Aiglondur
            message= _ "The lich surely awaits us within. We must be on guard."
        [/message]

        {VARIABLE show_status yes}

        [show_objectives]
        [/show_objectives]
    [/event]

    # indicate next steps
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=36-38
            y=21-23
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL key_read equals no}
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "It seems that the guard spoke the truth. These doors will not open to us!"
        [/message]

        [message]
            speaker=Angras
            message= _ "They are sealed by the ancient runelore of the Hammer. No amount of force can open these doors - we will need to find the keys to the seals here."
        [/message]

        # set it to yes and display message
        {VARIABLE key_read yes}

        # show us the first status
        [hint_message]
            caption= _ "Scenario Progression:"
            message= {NRR_S08_STATUS_UPDATE_MSG}
        [/hint_message]
    [/event]

    # status updater
    [event]
        name="new turn"
        first_time_only=no
        [filter_condition]
            {VARIABLE_CONDITIONAL key_read equals yes}
        [/filter_condition]

        [hint_message]
            caption= _ "Scenario Progression:"
            message= {NRR_S08_STATUS_UPDATE_MSG}
        [/hint_message]
    [/event]
    [event]
        name="new turn"
        first_time_only=no
        [filter_condition]
            {VARIABLE_CONDITIONAL show_status equals yes}
        [/filter_condition]

        [hint_message]
            caption= _ "Scenario Objectives:"
            message= {NRR_S08_STATUS_UPDATE_MSG2}
        [/hint_message]
    [/event]

    # speed runes
    {PLACE_SPEED_RUNE 23 15}
    {PLACE_SPEED_RUNE 25 10}
    {PLACE_SPEED_RUNE 28 18}
    {PLACE_SPEED_RUNE 30 25}
    {PLACE_SPEED_RUNE 23 22}
    {PLACE_SPEED_RUNE 24 27}
    {PLACE_SPEED_RUNE 17 31}

    # damage runes
    {PLACE_FIRE_BLAST_RUNE  9  5}
    {PLACE_FIRE_BLAST_RUNE 11  7}
    {PLACE_FIRE_BLAST_RUNE 19  7}
    {PLACE_FIRE_BLAST_RUNE 24 11}
    {PLACE_FIRE_BLAST_RUNE 28 13}
    {PLACE_FIRE_BLAST_RUNE 32 12}
    {PLACE_FIRE_BLAST_RUNE 34  6}
    {PLACE_FIRE_BLAST_RUNE 40  5}
    {PLACE_FIRE_BLAST_RUNE 23 19}
    {PLACE_FIRE_BLAST_RUNE 23 21}
    {PLACE_FIRE_BLAST_RUNE 29 26}
    {PLACE_FIRE_BLAST_RUNE 29 30}
    {PLACE_FIRE_BLAST_RUNE 31 36}
    {PLACE_FIRE_BLAST_RUNE 33 34}

    {PLACE_FIRE_BLAST_RUNE 46 21}
    {PLACE_FIRE_BLAST_RUNE 44 22}

    # heal runes
    # not too many though
    {PLACE_HEAL_RUNE 32 21}
    {PLACE_HEAL_RUNE 41 31}
    {PLACE_HEAL_RUNE 25 25}
    {PLACE_HEAL_RUNE 35  4}
    {PLACE_HEAL_RUNE 32 21}
    {PLACE_HEAL_RUNE 43 21}

    # teleportation runes
    {PLACE_TELEPORT_RUNE 1 10  8 25 22 ({VARIABLE_CONDITIONAL rune_three equals yes})}
    {PLACE_TELEPORT_RUNE 1 42  3 30 19 ({VARIABLE_CONDITIONAL rune_one equals yes})}
    {PLACE_TELEPORT_RUNE 1 38 36 28 23 ({VARIABLE_CONDITIONAL rune_two equals yes})}

    # prisoner events
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=20,21
            y= 7, 8
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr\o
            x,y=20,8
        [/terrain]

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=23-24
            y= 7
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr\o
            x,y=24,6
        [/terrain]

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=44
            y=31
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr\o
            x,y=45,31
        [/terrain]

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=41,42
            y=31,30
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr/o
            x,y=41,30
        [/terrain]

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    # knalgan alliance prisoners
    # as in each one rescued will join the player
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=19
            y=32
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr/o
            x,y=20,32
        [/terrain]

        {MODIFY_UNIT (x,y=21,34) side 1}

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=10, 9
            y=30,30
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr\o
            x,y=9,31
        [/terrain]

        {MODIFY_UNIT (x,y=8,32) side 1}

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=14,15
            y=33,33
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr/o
            x,y=15,34
        [/terrain]

        {MODIFY_UNIT (x,y=16,35) side 1}

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=11,12
            y=28,27
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr/o
            x,y=11,27
        [/terrain]

        {MODIFY_UNIT (x,y=9,26) side 1}

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=14,15
            y=27,27
        [/filter]

        [sound]
            name=mace.wav
        [/sound]

        [terrain]
            terrain=Uu^Pr/o
            x,y=14,26
        [/terrain]

        {MODIFY_UNIT (x,y=13,25) side 1}

        [redraw]
            side=1
            clear_shroud=yes
        [/redraw]
    [/event]

    # boss side events
    [event]
        name=last breath
        [filter]
            id=clockwork_knight_boss
        [/filter]

        # some dialogue by Angras/Tallin/Aiglondur
    [/event]

    [event]
        name=die
        [filter]
            id=clockwork_knight_boss
        [/filter]

        {VARIABLE boss_defeated yes}

        # check if two other conditions have been met
        [if]
            {VARIABLE_CONDITIONAL enemies_defeated equals yes}
            [and]
                {VARIABLE_CONDITIONAL vip_prisoners_rescued equals yes}
            [/and]
            # if yes to all 3, we end
            [then]
                [fire_event]
                    name=end_underlevels_exploration
                [/fire_event]
            [/then]
            # if not, we keep playing
            [else]
                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # event for eryssa and elenia
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=8-13
            y=3-10
        [/filter]

        {SCROLL_TO 12 10}

        [remove_shroud]
            side=1
            x,y=12,10
            radius=1
        [/remove_shroud]
        [redraw]
            side=1
        [/redraw]

        # some dialogue of please save us?
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x=10,11,12
            y= 9, 9, 8
        [/filter]

        [delay]
            time=1000
        [/delay]

        [sound]
            name=mace.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [terrain]
            x=11,12
            y=10, 9
            terrain=Uu^Pr/o
        [/terrain]
        [redraw]
            clear_shroud=yes
            side=1
        [/redraw]

        # some dialogue of having freed elven noblewoman

        # add micro AI to stop these units from dying
        {COWARD_GUARDIAN_MICRO_AI 7 add (
            [filter]
                id="Eryssa"
            [/filter]
        ) 5 ()}
        {COWARD_GUARDIAN_MICRO_AI 7 add (
            [filter]
                id="Elenia"
            [/filter]
        ) 5 ()}

        {VARIABLE vip_prisoners_rescued yes}

        # check if two other conditions have been met
        [if]
            {VARIABLE_CONDITIONAL boss_defeated equals yes}
            [and]
                {VARIABLE_CONDITIONAL enemies_defeated equals yes}
            [/and]
            # if yes to all 3, we end
            [then]
                [fire_event]
                    name=end_underlevels_exploration
                [/fire_event]
            [/then]
            # if not, we keep playing
            [else]
                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # enemies defeated
    [event]
        name=enemies_defeated

        {VARIABLE enemies_defeated yes}

        # check if two other conditions have been met
        [if]
            {VARIABLE_CONDITIONAL boss_defeated equals yes}
            [and]
                {VARIABLE_CONDITIONAL vip_prisoners_rescued equals yes}
            [/and]
            # if yes to all 3, we end
            [then]
                [fire_event]
                    name=end_underlevels_exploration
                [/fire_event]
            [/then]
            # if not, we keep playing
            [else]
                [show_objectives]
                [/show_objectives]
            [/else]
        [/if]
    [/event]

    # turns over
    [event]
        name=time over

        # make a lot of masked dwarves showup near the entrance.

        {ENDLEVEL_DEFEAT}
    [/event]

    # final event
    [event]
        name=end_underlevels_exploration
        first_time_only=yes

        # clean up
        {CLEAR_VARIABLE enemies_defeated,boss_defeated,vip_prisoners_rescued,rune_one,rune_three,rune_two,runes_activated,show_status}

        # clear the enchanting vars
        {NRR_CLEAR_ENCHANTS_VARS 1}

        # clean menu
        [clear_menu_item]
            id=nrr_rune_desc_help
        [/clear_menu_item]

        {ENDLEVEL_VICTORY 40 no}
    [/event]

    # Eryssa is essential here
    [event]
        name="last breath"
        [filter]
            id="Eryssa"
        [/filter]

        # dialogue here
    [/event]

    [event]
        name="die"
        [filter]
            id="Eryssa"
        [/filter]

        {ENDLEVEL_DEFEAT}
    [/event]

    # not her hotter sister though
    [event]
        name="last breath"
        [filter]
            id="Elenia"
        [/filter]

        # dialogue here
    [/event]

    # events for stunting player's economy
    # necessary as gold flows in abundantly after turn 20
    [event]
        name=turn 16
        first_time_only=no

        [modify_side]
            side=1
            # was 4/3/3
            village_support=2
        [/modify_side]
    [/event]
    [event]
        name=turn 24
        first_time_only=no

        [modify_side]
            side=1
            # was 2
            village_support=1
        [/modify_side]
    [/event]

    {RENAME_MASKED_DWARVES 3,4,5}

    # grimoire page pickup event
    {PLACE_IMAGE "items/book2.png" 47 31}

    [event]
        name="moveto"
        first_time_only=yes
        [filter]
            id="Tallin"
            x,y=47,31
        [/filter]

        {REMOVE_IMAGE 47 31}

        # some dialogue from the book
        # about "more powa!"

        {VARIABLE_OP pages_found add 1}
    [/event]
    
    # Setting: within Kal Kartha
    # Tallin and co explore the winding underlevels under Kal Kartha proper, discovering the horrors of Karrag's experiments.
    {HERO_DEATH_EVENTS}
#undef NRR_S08_STATUS_UPDATE_MSG
#undef NRR_S08_STATUS_UPDATE_MSG2
[/scenario]
