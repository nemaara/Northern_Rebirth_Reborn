#textdomain wesnoth-nrr

[scenario]
    id=11_Smoldering_Fracture
    name= _ "Smoldering Fracture"
    map_file=11_Smoldering_Fracture.map
    
    # you can lose when more drakes show up
    {TURNS 90 90 90}

    next_scenario=11x_Victory_or_Death
    victory_when_enemies_defeated=yes
    {XP_MODIFIER_NRR}

    # these are now constants
    {NRR_LOAD_RESOURCES}
    {ENABLE_DWARVISH_RUNESMITH}
    {NRR_ENCHANTING_SYSTEM}
    [load_resource]
        id=nrr_rune_info_help
    [/load_resource]

    # music playlist
    {DEFAULT_MUSIC_PLAYLIST}

    # adjusted schedule

    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    {DAWN}
    # favour drakes
    {MORNING}
    {MIDDAY}
    {MIDDAY}
    {AFTERNOON}

    # time area
    # underground
    [time_area]
        x=55-89,17,   18,   19,   20,   21,   22,   23,24-27,   28,   29,   30,   31,   32,   33,   34
        y= 0-67,67,65-67,64-67,63-67,63-67,63-67,63-67,62-67,61-67,62-67,61-67,62-67,63-67,65-67,66-67
        {UNDERGROUND}
    [/time_area]
    # indoors
    [time_area]
        x="5,6,7,8,9,10,11,12,13,14,14,15,16,17,18,19,20,21,21,22,23,24,24,25,26,27,28,29,30,30,31,32,33,34,35,36,37,38,39,40,40,14,21,24,30"
        y="14-19,13-20,14-22,13-23,13-25,13-25,13-26,12-26,13-27,12-13,15-27,12-28,12-28,13-28,12-28,12-29,11-28,11-18,20-29,11-29,11-29,11-18,20-29,12-29,11-28,12-29,11-29,12-29,12-13,15-29,13-30,12-29,13-29,13-29,13-29,13-28,13-28,13-27,15-27,19-21,23-26,14,19,19,14"
        {INDOORS}
    [/time_area]

    # Tallin
    [side]
        side=1
        controller=human
        {CHARACTER_STATS_TALLIN}
        {FLAG_VARIANT knalgan}
        team_name="player"
        user_team_name= _ "Knalgan Alliance"
        shroud=yes
        fog=no
        share_vision=all
        recall_cost={ON_DIFFICULTY 8 10 12}
        # biggest battle scenario
        # go wild
        {GOLD 750 620 500}
        {INCOME 14 12 10}
        village_support={ON_DIFFICULTY 7 6 5}
        recruit={KNALGAN_ALLIANCE_RECRUIT_LIST_FULL}
    [/side]

    {STARTING_VILLAGES 1 6}

    # zorfu
    [side]
        side=2
        controller=ai
        persistent=yes
        save_id=Zorfu
        {WITHERVEIN_ORCS}
        {CHARACTER_STATS_ZORFU}
        {FLAG_VARIANT6 ragged}
        team_name="player"
        user_team_name= _ "Withervein Orcs"
        shroud=yes
        fog=no
        share_vision=all
        recall_cost={ON_DIFFICULTY 10 12 15}

        # biggest battle scenario
        # go wild
        {GOLD 750 620 500}
        {INCOME 14 16 20}
        village_gold=2
        village_support={ON_DIFFICULTY 5 4 3}

        recruit={ORC_CLAN_WITHERVEIN_RECRUIT_LIST}
        {CHAOTIC_AI_PARAMS}
        [ai]
            [avoid]
                # stop putting units on my keep
                x,y=22,61
            [/avoid]
        [/ai]
    [/side]

    {STARTING_VILLAGES 2 6}

    # Hamel
    [side]
        side=3
        controller=ai
        {CHARACTER_STATS_HAMEL}
        {FLAG_VARIANT knalgan}
        team_name=player
        user_team_name= _ "Knalga"
        {KNALGAN_ALLIANCE_DWAVRES}
        shroud=yes
        fog=no
        share_vision=all
        {GOLD 750 620 500}
        {INCOME 14 16 20}
        recall_cost={ON_DIFFICULTY 10 12 15}
        village_support={ON_DIFFICULTY 5 4 3}
        recruit={KNALGAN_ALLIANCE_DWARVES_RECRUITS}
        {NEUTRAL_AI_PARAMS}
    [/side]

    {STARTING_VILLAGES 3 12}

    # prevent ally from going overboard
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Steelclad" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Thunderguard" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Pathfinder" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Stalwart" {ON_DIFFICULTY 2 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Berserker" {ON_DIFFICULTY 2 2 2}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Fighter" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Thunderer" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Scout" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Guardsman" {ON_DIFFICULTY 2 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Dwarvish Ulfserker" {ON_DIFFICULTY 2 2 2}}

    # Masked Dwarves
    [side]
        side=4
        controller=ai
        id=Ancatil
        name= _ "Masked Dwarf"
        type=Dwarvish Masked Sentinel
        canrecruit=yes
        unrenamable=yes
        [modifications]
            # make him a pain to dispatch
            {TRAIT_ELITE}
            {TRAIT_STRONG}
        [/modifications]

        {KARRAG_LOYALISTS}
        {FLAG_VARIANT knalgan}
        team_name=karrag
        user_team_name= _ "Masked Dwarves"

        {GOLD 320 440 560}
        {INCOME 6 8 10}
        recruit={KAL_KARTHA_MASKED_DWARVES_ELITES}
        village_gold=1
        village_support={ON_DIFFICULTY 4 6 8}
        {NEUTRAL_AI_PARAMS}
        [ai]
            passive_leader=yes
        [/ai]
    [/side]

    {STARTING_VILLAGES 4 6}

    # limit recruits
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Lord" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Dragonguard" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Sentinel" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Berserker" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Fighter" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Thunderer" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Guardsman" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Ulfserker" {ON_DIFFICULTY 3 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Dwarvish Masked Stalwart" {ON_DIFFICULTY 4 4 5}}

    # saurians
    [side]
        side=5
        controller=ai
        id=Xerxix
        name= _ "Xerxix"
        type="Saurian Prophet"
        [modifications]
            {TRAIT_ELITE}
            {TRAIT_QUICK}
        [/modifications]
        canrecruit=yes
        unrenamable=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Saurians"

        {GOLD 320 440 560}
        {INCOME 6 8 10}

        # the full set
        recruit="Saurian Skirmisher, Saurian Augur, Saurian Oracle, Saurian Spearthrower, Saurian Ambusher, Saurian Soothsayer, Saurian Flanker, Saurian Javelineer,Saurian Seer,Saurian Prophet"
        {CHAOTIC_AI_PARAMS}
        [ai]
            # please no suicide
            passive_leader=yes

            [goal]
                [criteria]
                    side=3
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 5 6}

    # make saurians be mostly level 2
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Skirmisher" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Augur" {ON_DIFFICULTY 3 4 5}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Javelineer" {ON_DIFFICULTY 4 4 5}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Flanker" {ON_DIFFICULTY 4 4 5}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Prophet" {ON_DIFFICULTY 5 6 7}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Seer" {ON_DIFFICULTY 3 3 4}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Ambusher" {ON_DIFFICULTY 4 4 5}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Spearthrower" {ON_DIFFICULTY 4 4 5}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Soothsayer" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Saurian Oracle" {ON_DIFFICULTY 5 6 7}}

    # Drakes
    [side]
        side=6
        controller=ai
        # if you see a drake with double names
        # it's because he comes from a 
        # reputed lineage
        id="Velnick Markan"
        name= _ "Velnick Markan"
        canrecruit=yes
        
        type=Drake Subjugator
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]
        unrenamable=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Drakes"

        {GOLD 320 440 560}
        {INCOME 42 48 56}
        # most except clasher caste (for obvious regions)
        recruit="Drake Burner, Drake Fighter, Drake Glider, Drake Smasher, Drake Smasher, Fire Drake, Drake Flare, Sky Drake, Drake Adventurer, Drake Ranger, Hurricane Drake, Drake Subjugator, Drake Flameheart, Inferno Drake"
        village_gold=1
        village_support={ON_DIFFICULTY 4 6 8}
        {LAWFUL_AI_PARAMS}
        [ai]
            [goal]
                [criteria]
                    side=3
                [/criteria]
                value=500
            [/goal]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 6 12}

    # I want drakes to focus on smashers and fires so limiting the rest
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Subjugator" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Hurricane Drake" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Ranger" {ON_DIFFICULTY 3 4 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Flameheart" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Inferno Drake" {ON_DIFFICULTY 3 3 4}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Burner" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Glider" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Fighter" {ON_DIFFICULTY 2 3 3}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Flare" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Sky Drake" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Drake Adventurer" {ON_DIFFICULTY 3 4 4}}

    # Drakes
    [side]
        side=7
        controller=ai
        id="Merkush Karron"
        name= _ "Merkush Karron"
        canrecruit=yes
        
        type=Drake Blademaster
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_FEARLESS}
        [/modifications]
        unrenamable=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Drakes"

        {GOLD 320 440 560}
        {INCOME 42 48 56}
        # most except clasher caste (for obvious regions)
        recruit="Drake Burner, Drake Fighter, Drake Glider, Drake Warrior, Drake Smasher, Fire Drake, Drake Flare, Sky Drake, Drake Adventurer, Drake Ranger, Hurricane Drake, Drake Blademaster, Drake Flameheart, Inferno Drake"
        village_gold=1
        village_support={ON_DIFFICULTY 4 6 8}
        {LAWFUL_AI_PARAMS}
        [ai]
            [goal]
                [criteria]
                    side=10
                [/criteria]
                value=500
            [/goal]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 7 12}

    # I want drakes to focus on warriors and fires so limiting the rest
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Blademaster" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Hurricane Drake" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Ranger" {ON_DIFFICULTY 3 4 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Flameheart" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Inferno Drake" {ON_DIFFICULTY 3 3 4}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Burner" {ON_DIFFICULTY 2 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Glider" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Fighter" {ON_DIFFICULTY 2 3 3}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Flare" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Sky Drake" {ON_DIFFICULTY 2 2 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 7 "Drake Adventurer" {ON_DIFFICULTY 3 4 4}}

    # Drakes
    # Lord Mar'Ildian
    # Armaggeddon Drake
    [side]
        side=8
        controller=ai
        id="Mar_Ildian"
        name= _ "Lord Marâ€™Ildian"
        canrecruit=yes
        
        type=Armageddon Drake
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_DEXTROUS}
        [/modifications]
        unrenamable=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Drakes"

        {GOLD 320 440 560}
        {INCOME 42 48 56}
        recruit="Drake Flameheart, Fire Drake, Drake Warrior, Drake Blademaster, Inferno Drake, Armageddon Drake"
        village_gold=1
        village_support={ON_DIFFICULTY 4 6 8}
        {LAWFUL_AI_PARAMS}
        [ai]
            [goal]
                [criteria]
                    side=3
                [/criteria]
                value=500
            [/goal]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 8 12}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Armageddon Drake" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Drake Flameheart" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Drake Blademaster" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Inferno Drake" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Drake Warrior" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Fire Drake" {ON_DIFFICULTY 3 3 4}}

    # do not let him to die
    {FORCE_CHANCE_TO_HIT (side=1) (id="Mar_Ildian") 0 (
        {VARIABLE_CONDITIONAL turn_number greater_than 0}
    )}

    # Drakes
    # Lord Karri Kon
    # Armageddon Drake
    [side]
        side=9
        controller=ai
        id="Karri Kon"
        name= _ "Lord Karri Kon"
        canrecruit=yes
        
        type=Armageddon Drake
        [modifications]
            {TRAIT_FEARLESS}
            {TRAIT_STRONG}
        [/modifications]
        unrenamable=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Drakes"

        {GOLD 320 440 560}
        {INCOME 42 48 56}
        # recruit the heavy ones
        recruit="Drake Flameheart, Fire Drake, Drake Warrior, Drake Blademaster, Inferno Drake, Armageddon Drake"
        village_gold=1
        village_support={ON_DIFFICULTY 4 6 8}
        {LAWFUL_AI_PARAMS}
        [ai]
            [goal]
                [criteria]
                    side=10
                [/criteria]
                value=500
            [/goal]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=100
            [/goal]
        [/ai]
    [/side]

    {STARTING_VILLAGES 9 12}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Armageddon Drake" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Drake Flameheart" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Drake Blademaster" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Inferno Drake" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Drake Warrior" {ON_DIFFICULTY 3 3 4}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 9 "Fire Drake" {ON_DIFFICULTY 3 3 4}}

    # do not let him to die
    {FORCE_CHANCE_TO_HIT (side=1) (id="Karri Kon") 0 (
        {VARIABLE_CONDITIONAL turn_number greater_than 0}
    )}
    
    # Eryssa
    [side]
        side=10
        location_id=Eryssa_start_pos
        controller=ai
        canrecruit=yes
        # her surival is not relevant
        {IS_EXPENDABLE_LEADER}
        {CHARACTER_STATS_ERYSSA}

        {ELVES_LINTAIR}
        team_name=player
        user_team_name= _ "Lintair Forest"
        {FLAG_VARIANT wood-elvish}

        {GOLD 580 520 480}
        {INCOME 20 18 16}
        shroud=yes
        share_vision=all

        # no scouts
        recruit="Elvish Fighter, Elvish Archer, Elvish Shaman, Elvish Hero, Elvish Marksman, Elvish Ranger, Elvish Hero, Elvish Captain, Elvish Marshal, Elvish Sharpshooter, Elvish Avenger, Elvish Champion, Elvish Druid, Elvish Sorceress, Elvish Shyde,Wose,Elder Wose,Wose Shaman,Ancient Wose"
        {NEUTRAL_AI_PARAMS}

        # her loyal subjects
        [unit]
            side=10
            placement=leader
            {CHARACTER_STATS_ELENIA}
            # please behave
            [status]
                guardian=yes
            [/status]
            # ensure hot elf no die
            # otherwise rushes to attack and get killed
            moves=3
            max_moves=3
        [/unit]
        [unit]
            side=10
            placement=leader
            {IS_LOYAL}
            id="Silmaclya"
            name= _ "female^Silmaclya"
            gender="female"
            experience={ON_DIFFICULTY 20 30 50}
            type={ON_DIFFICULTY "Elvish Ranger" "Elvish Avenger" "Elvish Avenger"}
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
        [unit]
            side=10
            placement=leader
            {IS_LOYAL}
            id="Hithrandel"
            name= _ "Hithrandel"
            type="Elvish Marshal"
            experience={ON_DIFFICULTY 24 35 43}
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]
    [/side]

    # limit her usage of level 1 and level 3
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Shyde" {ON_DIFFICULTY 4 4 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Marshal" {ON_DIFFICULTY 2 2 1}}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Champion" {ON_DIFFICULTY 4 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Avenger" {ON_DIFFICULTY 4 3 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Sharpshooter" {ON_DIFFICULTY 4 3 3}}
    # they can kill drakes easily but can also be dispatched rather fast
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Ancient Wose" 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elder Wose" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Wose Shaman" 2}

    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Captain" {ON_DIFFICULTY 2 1 1}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Druid" {ON_DIFFICULTY 2 2 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Fighter" {ON_DIFFICULTY 5 4 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Archer" {ON_DIFFICULTY 5 4 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Elvish Shaman" {ON_DIFFICULTY 4 4 3}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 10 "Wose" 2}

    # God Dragon Kergeom himself
    [side]
        side=11
        controller=ai
        no_leader=yes
        {DRAKES_SAURIANS_KERGEOM}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Drakes"
        {HIDDEN_TEAM}
        {NO_ECONOMY}
        {NO_RECRUITMENT}
        # the boss arena is in a neutral ToD
        {NEUTRAL_AI_PARAMS}
    [/side]

    # enemy guards, spawner side
    [side]
        side=12
        controller=ai
        no_leader=yes
        {KARRAG_LOYALISTS}
        {FLAG_VARIANT long}
        team_name=karrag
        user_team_name= _ "Monsters"
        {HIDDEN_TEAM}
        {NO_ECONOMY}
        {NO_RECRUITMENT}
        {NEUTRAL_AI_PARAMS}
    [/side]

    [side]
        side=13
        controller=ai
        no_leader=yes
        color=white
        team_name=player
        user_team_name= _ "Knalgan Alliance"
        {FLAG_VARIANT ragged}
        shroud=yes
        share_vision=all
        {HIDDEN_TEAM}
        {NO_ECONOMY}
        {NO_RECRUITMENT}
        {CHAOTIC_AI_PARAMS}
    [/side]

    # prestart
    [event]
        name=prestart

        # give Hamel his well deserved lord of all Knalga buff
        {SCENARIO_11_HAMEL_REINFORCEMENTS}

        # recall the regulars
        {RECALL "Aiglondur"}
        # weirdly enough, Stalrag (side 2 is also recalled)
        # need to accomodate him in the code
        {RECALL_LOYALS}

        # make atmosphere omnious
        {COLOR_ADJUST -25 -25 -25}

        # scenario progression counter
        # stageOne - start
        # stageTwo - Kergeom boss fight
        # stageThree - True Kergeom boss fight
        # also controls roar effect
        {VARIABLE scenario_11_stage "stageOne"}

        {VARIABLE eryssa_alive_check yes}
        {VARIABLE eryssa_friendly yes}

        {VARIABLE rune_one_active no}
        {VARIABLE rune_two_active no}
        {VARIABLE rune_three_active no}
        {VARIABLE rune_four_active no}

        # objectives
        [objectives]
            side=1
            silent=no
            [objective]
                description= _ "Confront Dragon Lord Kergeom"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_11_stage equals "stageOne"}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Subdue Dragon Lord Kergeom"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_11_stage equals "stageTwo"}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Destroy the Clockwok Dragon Kergeom"
                condition="win"
                [show_if]
                    {VARIABLE_CONDITIONAL scenario_11_stage equals "stageThree"}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of Tallin"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Aiglondur"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Angras"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Hamel"
                condition="lose"
            [/objective]
            [objective]
                description= _ "Death of Zorfu"
                condition="lose"
            [/objective]
            {TURNS_RUN_OUT}

            [note]
                description= _ "Right-Click Tallin to view Enchanting Help"
            [/note]
            [note]
                description= _ "Right-Click Angras to view Rune Descriptions"
            [/note]
            [note]
                description= _ "Avoid attacking Shrooms"
            [/note]

            [note]
                description= _ "Find some way to advance into Gom Thurim"
            [/note]
            [note]
                description= _ "Right-Click Menu commands to control Zorfu are available"
            [/note]
            [note]
                description= _ "Right-Click Menu commands to control Hamel are available"
            [/note]

            # go all out
            [gold_carryover]
                carryover_percentage=0
                bonus=no
            [/gold_carryover]
        [/objectives]

        # spawned units
        {MASKED_DWARF 4 "Dwarvish Masked Guardsman" 14 57}
        {MASKED_DWARF 4 "Dwarvish Masked Guardsman" 16 57}

        {MASKED_DWARF 4 "Dwarvish Masked Stalwart" 38 57}
        {MASKED_DWARF 4 "Dwarvish Masked Stalwart" 37 58}

        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 61 29}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 61 40}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 83 40}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 83 29}

        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 60 28}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 62 29}

        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 60 39}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 62 40}

        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 82 28}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 84 29}

        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 82 39}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES}) 84 40}

        # shrooms
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 61 31}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 68 34}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 69 39}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 70 24}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 76 24}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 68 44}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 74 44}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 76 34}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 75 30}
        {RANDOM_SPAWN 12 ("Shroom,Shroom,Elder Shroom,Elder Shroom,Ancient Shroom") 83 38}

        # saurians
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 82 30}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 78 40}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 77 29}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 76 32}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 75 38}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 77 42}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 67 40}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 68 36}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 70 30}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 66 28}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 68 26}
        {RANDOM_SPAWN 12 ("Saurian Oracle,Saurian Spearthrower,Saurian Augur") 62 38}

        # Flesh Golems
        {GENERIC_UNIT 12 "Flesh Golem" 58 27}{GUARDIAN}
        {GENERIC_UNIT 12 "Flesh Golem" 58 40}{GUARDIAN}
        {GENERIC_UNIT 12 "Flesh Golem" 86 28}{GUARDIAN}
        {GENERIC_UNIT 12 "Flesh Golem" 85 41}{GUARDIAN}

        # abominations
        [random_placement]
            num_items={ON_DIFFICULTY 2 3 5}
            variable=loc
            min_distance=3
            [filter_location]
                x,y=58-86,24-45
                [not]
                    [filter][/filter]
                [/not]
            [/filter_location]
            [command]
                {NOTRAIT_UNIT 12 "Abomination" $loc.x $loc.y}{PASSABLE_CHECK}
            [/command]
        [/random_placement]

        # cave wyrms
        [random_placement]
            num_items={ON_DIFFICULTY 5 5 6}
            variable=loc
            min_distance=2
            [filter_location]
                x,y=58-86,23-45
                [not]
                    [filter][/filter]
                [/not]
            [/filter_location]
            [command]
                {RANDOM_SPAWN 12 ("Cave Wyrm,Cave Wyrm,Cave Wyrmlet") $loc.x $loc.y}
            [/command]
        [/random_placement]

        # scorpions
        [random_placement]
            num_items={ON_DIFFICULTY 4 6 9}
            variable=loc
            min_distance=3
            [filter_location]
                x,y=58-86,23-45
                [not]
                    [filter][/filter]
                [/not]
            [/filter_location]
            [command]
                {RANDOM_SPAWN 12 ("Giant Scorpion,Giant Scorpling,Rock Scorpion") $loc.x $loc.y}
            [/command]
        [/random_placement]

        # clockwork berserkers
        {GENERIC_UNIT 12 "Clockwork Berserker" 67 29}{GUARDIAN}
        {GENERIC_UNIT 12 "Clockwork Berserker" 73 24}{GUARDIAN}
        {GENERIC_UNIT 12 "Clockwork Berserker" 73 31}{GUARDIAN}
        {GENERIC_UNIT 12 "Clockwork Berserker" 71 38}{GUARDIAN}
        {GENERIC_UNIT 12 "Clockwork Berserker" 71 45}{GUARDIAN}
        {GENERIC_UNIT 12 "Clockwork Berserker" 77 40}{GUARDIAN}

        # cave critters
        [random_placement]
            num_items={ON_DIFFICULTY 5 8 11}
            variable=loc
            min_distance=2
            [filter_location]
                x,y=58-86,23-45
                [not]
                    [filter][/filter]
                [/not]
            [/filter_location]
            [command]
                {RANDOM_SPAWN 12 ("Giant Ant,Giant Rat,Fire Ant") $loc.x $loc.y}
            [/command]
        [/random_placement]

        # wyverns
        {GENERIC_UNIT 12 "Wild Wyvern"  4 23}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern" 13 35}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern"  6 31}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern"  7 41}{GUARDIAN}

        {GENERIC_UNIT 12 "Wild Wyvern" 10 48}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern" 37 52}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern" 40 44}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern" 41 32}{GUARDIAN}
        {GENERIC_UNIT 12 "Wild Wyvern" 43 12}{GUARDIAN}

        # lava bursts
        {LAVA_OUTBURST 44 53}
        {LAVA_OUTBURST 32 50}
        {LAVA_OUTBURST 45 47}
        {LAVA_OUTBURST 31 46}

        {LAVA_OUTBURST 42 39}
        {LAVA_OUTBURST 32 38}

        {LAVA_OUTBURST 33 33}
        {LAVA_OUTBURST 41 29}

        {LAVA_OUTBURST 43 23}
        {LAVA_OUTBURST 46 16}

        {LAVA_OUTBURST 44  8}
        {LAVA_OUTBURST 32 10}
        {LAVA_OUTBURST 24  8}
        {LAVA_OUTBURST 12  9}
        {LAVA_OUTBURST  3 12}
        {LAVA_OUTBURST  2 21}
        {LAVA_OUTBURST  8 27}

        {LAVA_OUTBURST 11 30}
        {LAVA_OUTBURST 17 32}
        {LAVA_OUTBURST  3 37}
        {LAVA_OUTBURST 12 44}
        {LAVA_OUTBURST 44  8}
        {LAVA_OUTBURST  4 42}
        {LAVA_OUTBURST  9 52}

        # optimise AI with MAI
        {FAST_MAI_ADD 2}
        {FAST_MAI_ADD 3}
        {FAST_MAI_ADD 4}
        {FAST_MAI_ADD 5}
        {FAST_MAI_ADD 6}
        {FAST_MAI_ADD 7}
        {FAST_MAI_ADD 8}
        {FAST_MAI_ADD 9}
        {FAST_MAI_ADD 10}

        # further optimisations

        # programmed AI for elves
        # stay in forests and exploit that 70% Defence
        {HEALER_SUPPORT_MAI 10 add (
            [filter]
                type=Elvish Shaman,Elvish Druid,Elvish Shyde
            [/filter]
        ) () 0.00}

        [micro_ai]
            side=10
            ai_type=lurkers
            action=add

            [filter]
                type_adv_tree=Wose,Wose Shaman,Elvish Ranger
            [/filter]
            [filter_location]
                terrain=*^F*
            [/filter_location]
            [filter_location_wander]
                terrain=*^F*
            [/filter_location_wander]
            ca_score=400000
        [/micro_ai]

        {ZONE_GUARDIAN_MAI 10 add (
            [filter]
                side=10
                canrecruit=no
                [not]
                    type_adv_tree=Wose,Wose Shaman,Elvish Ranger
                [/not]
            [/filter]
        ) (
            [filter_location]
                x=32-47
                y=58-66
            [/filter_location]
        ) (
            ca_score=350000
        )}

        # saurians
        {HEALER_SUPPORT_MAI 5 add (
            [filter]
                type=Saurian Augur,Saurian Soothsayer,Saurian Seer
            [/filter]
        ) () 0.30}

        # dwarves (Hamel)
        # do not let him expose units in poor defence
        # where drakes can pick them easily
        {ZONE_GUARDIAN_MAI 3 add (
            [filter]
                side=3
                canrecruit=no
            [/filter]
        ) (
            [filter_location]
                x=1-19
                y=54-66
            [/filter_location]
        ) (
            ca_score=350000
        )}

        # drakes
        # make 2 of the 4 drake sides focus aggressively on the allies
        # other sides are supposed to provide hindrance
        # for the player and zorfu
        {ZONE_GUARDIAN_MAI 8 add (
            [filter]
                side=8
                canrecruit=no
            [/filter]
        ) (
            [filter_location]
                x=1-19
                y=54-66
            [/filter_location]
        ) (
            ca_score=350000
        )}
        {ZONE_GUARDIAN_MAI 9 add (
            [filter]
                side=9
                canrecruit=no
            [/filter]
        ) (
            [filter_location]
                x=32-47
                y=58-66
            [/filter_location]
        ) (
            ca_score=350000
        )}

        # tunnels
        # mostly for AI units to help out
        # player in the underground zone
        [tunnel]
            id=tunnel_passage_A
            [filter]
                side=1,2,3,10
            [/filter]

            [source]
                x=15
                y=54
            [/source]

            [target]
                x,y=67,38
            [/target]

            bidirectional=yes
            always_visible=yes
            allow_vision=yes
        [/tunnel]

        [tunnel]
            id=tunnel_passage_B
            [filter]
                side=1,2,3,10
            [/filter]

            [source]
                x=37
                y=57
            [/source]

            [target]
                x,y=77,37
            [/target]

            bidirectional=yes
            always_visible=yes
            allow_vision=yes
        [/tunnel]

        # give zorfu some goblin riders
        {RANDOM_SPAWN 2 ("Goblin Pillager,Goblin Knight,Goblin Wolf Marksman") 28 66}
        {RANDOM_SPAWN 2 ("Goblin Pillager,Goblin Knight,Goblin Wolf Marksman") 28 66}
        {RANDOM_SPAWN 2 ("Wolf Rider,Goblin Wolf Archer,Goblin Wolf Archer") 28 66}
        {GENERIC_UNIT 2 "Direwolf Rider" 28 66}

        # add proximity guards of Gom Thurim
        {GENERIC_UNIT 12 "Clockwork Ballista" 22 29}
        {GENERIC_UNIT 12 "Clockwork Ballista" 24 29}

        {GENERIC_UNIT 12 "Clockwork Ballista" 12 26}
        {GENERIC_UNIT 12 "Clockwork Ballista"  5 19}

        {GENERIC_UNIT 12 "Clockwork Ballista"  8 13}
        {GENERIC_UNIT 12 "Clockwork Ballista" 14 12}

        {GENERIC_UNIT 12 "Clockwork Ballista" 20 21}
        {GENERIC_UNIT 12 "Clockwork Ballista" 27 12}

        {GENERIC_UNIT 12 "Clockwork Ballista" 35 13}
        {GENERIC_UNIT 12 "Clockwork Ballista" 39 19}

        {GENERIC_UNIT 12 "Clockwork Ballista" 40 24}
        {GENERIC_UNIT 12 "Clockwork Ballista" 37 28}

        {GENERIC_UNIT 12 "Clockwork Ballista" 32 29}

        [capture_village]
            side=1
            x,y=20,60
        [/capture_village]
    [/event]

    {AI_CONTROLLER_ALLOW_MOVEMENT_CONTROL Zorfu 2}
    {AI_CONTROLLER_ALLOW_MOVEMENT_CONTROL Hamel 3}
    
    {SETUP_BRAZIERS}
    {SETUP_CAMPFIRES}

    # aesethetics
    [event]
        name="new turn"
        first_time_only=no

        [filter_condition]
            [lua]
                code=<<
                    return (wml.variables["turn_number"]%5 == 0)
                >>
            [/lua]
            # will play ever 5 turns...
            # until the special condition is met
            [and]
                {VARIABLE_CONDITIONAL scenario_11_stage not_equals "stageThree"}
            [/and]
        [/filter_condition]

        # hail Lord Kergeom, hapless fools!
        [sound]
            name=dragon-roar.ogg
        [/sound]
    [/event]

    # runes
    # speed
    {PLACE_SPEED_RUNE 27 50}
    {PLACE_SPEED_RUNE 31 55}
    {PLACE_SPEED_RUNE 21 49}
    {PLACE_SPEED_RUNE 22 45}
    {PLACE_SPEED_RUNE 20 40}
    {PLACE_SPEED_RUNE 22 35}
    {PLACE_SPEED_RUNE 27 33}
    {PLACE_SPEED_RUNE 22 32}

    # heal
    {PLACE_HEAL_RUNE 66 42}
    {PLACE_HEAL_RUNE 69 26}
    {PLACE_HEAL_RUNE 78 26}
    {PLACE_HEAL_RUNE 75 43}
    {PLACE_HEAL_RUNE 23 52}
    {PLACE_HEAL_RUNE 25 45}
    {PLACE_HEAL_RUNE 26 36}

    # cold damage
    # fire damage
    # death runes

    # teleport runes
    {PLACE_TELEPORT_RUNE 1 60 29 13 54 ({VARIABLE_CONDITIONAL rune_one_active equals yes})}
    {PLACE_TELEPORT_RUNE 1 60 40 13 55 ({VARIABLE_CONDITIONAL rune_two_active equals yes})}
    {PLACE_TELEPORT_RUNE 1 84 28 17 54 ({VARIABLE_CONDITIONAL rune_three_active equals yes})}
    {PLACE_TELEPORT_RUNE 1 84 39 17 55 ({VARIABLE_CONDITIONAL rune_four_active equals yes})}

    # start event
    [event]
        name=start

        {SIMPLE_MSG Aiglondur ( _ "Seems your scouts have not led us astray, Zorfu.")}

        {MOVE_UNIT (id="Aiglondur") 22 61}
        {MOVE_UNIT (id="Angras") 23 62}

        {SIMPLE_MSG Angras ( _ "I have only heard legends of this place. It was said to have the home of the first runemasters of a forgotten era. It was thought to have been lost to time.")}

        {SIMPLE_MSG Aiglondur ( _ "Yes, but it seems it to be standing. Perhaps Karrag somehow brought it back from the fallen depths.")}

        {SIMPLE_MSG Angras ( _ "Perhaps so. Now, I can only hope our allies get here.")}

        # Hamel's entrance
        {SCROLL_TO 3 66}
        {MOVE_UNIT (id="Hamel") 7 63}

        {SIMPLE_MSG Hamel ( _ "I got your message, nephew.")}
        {SIMPLE_MSG Aiglondur ( _ "Uncle! You have arrived!")}
        {SIMPLE_MSG Tallin ( _ "I hope you brought help. This battle will be something to remember.")}

        {SIMPLE_MSG Hamel ( _ "Aye. While you were all away on the expedition to Kal Kartha, I had been busy trying to reconnect our lost kinsmen.")}

        {SIMPLE_MSG Hamel ( _ "We established contact with many dwarven clans and I even found an old friend of mine!")}

        {MOVE_UNIT (id="Stalrag") 7 62}
        # fill his keep
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 7 63}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 7 63}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 7 63}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 7 63}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 7 63}

        {SIMPLE_MSG Stalrag ( _ "I am Stalrag, chieftain of the Shinsplitters. We are here to finally teach these overgrown lizards a lesson.")}

        {SIMPLE_MSG Hamel ( _ "Many dwarven clans are here with us today. You can say almost all of Knalga is participating in this battle.")}

        {SIMPLE_MSG Tallin ( _ "Zorfu, this is going to be wild!")}

        {SIMPLE_MSG Zorfu ( _ "There isn't any time to waste them. To battle!")}

        # this is better than the usual narrator message
        # as it cannot be skipped. So, players are aware
        # this is done so the player is allowed to field all their veterans
        # and experience epicness
        [alert]
            title= _ "Recall Cost Reduction"
            message= _ "Recall costs have been lowered for this scenario."
        [/alert]
    [/event]

    # eryssa, what are you doing here?
    [event]
        name="side 10 turn 1"

        {SCROLL_TO 41 64}

        {SIMPLE_MSG "Tallin" ( _ "Princess Eryssa?! What are you doing here?")}

        {SIMPLE_MSG "Eryssa" ( _ "Isn't it obvious, human? We repelled their offensive on our beloved Lins-Elen and followed their retreating troops to here. We intend to finish things.")}

        {SIMPLE_MSG "Aiglondur" ( _ "Princess, I propose an alliance against this enemy. There seem to be thousands of them and we could use the assitance.")}

        {SIMPLE_MSG "Elenia" ( _ "I think we should, sister.")}

        {SIMPLE_MSG "Eryssa" ( _ "Very well. I shall accept your request of an alliance. However, if my sister is taken from me due to your foolish tactic, I shall not hesitate to order my elves to attack your punitive forces.")}

        {SIMPLE_MSG "Zorfu" ({WHISPER ( _ "I don't like her, Tallin.")})}
        {SIMPLE_MSG "Tallin" ({WHISPER ( _ "Me neither.")})}
    [/event]

    {PLACE_IMAGE "scenery/rune4-glow.png" 15 54}
    {PLACE_IMAGE "scenery/rune4.png" 67 38}

    {PLACE_IMAGE "scenery/rune4-glow.png" 37 57}
    {PLACE_IMAGE "scenery/rune4.png" 77 37}

    {TELEPORT_TILE 15 54 67 38}
    {TELEPORT_TILE 37 57 77 37}

    # bridge control runes
    {PLACE_IMAGE "scenery/rune3.png" 59 27}
    {PLACE_IMAGE "scenery/rune3.png" 61 43}
    {PLACE_IMAGE "scenery/rune3.png" 83 26}
    {PLACE_IMAGE "scenery/rune3.png" 83 42}

    # inactive teleport runes
    {PLACE_IMAGE "scenery/rune4.png" 60 29}
    {PLACE_IMAGE "scenery/rune4.png" 13 54}
    {PLACE_IMAGE "scenery/rune4.png" 60 40}
    {PLACE_IMAGE "scenery/rune4.png" 13 55}
    {PLACE_IMAGE "scenery/rune4.png" 84 28}
    {PLACE_IMAGE "scenery/rune4.png" 17 54}
    {PLACE_IMAGE "scenery/rune4.png" 84 39}
    {PLACE_IMAGE "scenery/rune4.png" 17 54}

    # bridge control events

    # segment one
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=59,27
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL rune_one_active equals no}
        [/filter_condition]

        {SIMPLE_MSG unit ( _ "Huh, a rune?! Let me trigger it!")}

        # update rune
        {REMOVE_IMAGE 59 27}
        {PLACE_IMAGE "scenery/rune3-glow.png" 59 27}

        # update switch
        {VARIABLE rune_one_active yes}
        {REMOVE_IMAGE 60 29}
        {PLACE_IMAGE "scenery/rune4-glow.png" 60 29}
        {REMOVE_IMAGE 13 54}
        {PLACE_IMAGE "scenery/rune4-glow.png" 13 54}

        # scroll to
        {SCROLL_TO 23 50}
        [lock_view]
        [/lock_view]
        [remove_shroud]
            side=1
            x,y=23,50
            radius=3
        [/remove_shroud]
        [redraw]
        [/redraw]

        {THUNDER (
            [terrain]
                x=25,24
                y=50,50
                terrain=Ql^Bsb\
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=23,24
                y=50,49
                terrain=Ql^Bsb\
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=22
                y=49
                terrain=Ql^Bsb\
            [/terrain]
        )}
        [redraw]
        [/redraw]
        [unlock_view]
        [/unlock_view]

        # scroll back
        {SCROLL_TO 59 27}
    [/event]

    # segment two
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=61,43
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL rune_two_active equals no}
        [/filter_condition]

        {SIMPLE_MSG unit ( _ "Huh, a rune?! Let me trigger it!")}

        # update rune
        {REMOVE_IMAGE 61 43}
        {PLACE_IMAGE "scenery/rune3-glow.png" 61 43}

        # update switch
        {VARIABLE rune_two_active yes}
        {REMOVE_IMAGE 60 40}
        {PLACE_IMAGE "scenery/rune4-glow.png" 60 40}
        {REMOVE_IMAGE 13 55}
        {PLACE_IMAGE "scenery/rune4-glow.png" 13 55}

        # scroll to
        {SCROLL_TO 21 47}
        [lock_view]
        [/lock_view]
        [remove_shroud]
            side=1
            x,y=21,47
            radius=3
        [/remove_shroud]
        [redraw]
        [/redraw]

        {THUNDER (
            [terrain]
                x=21,22
                y=48,47
                terrain=Ql^Bsb\
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=20,21
                y=47,47
                terrain=Ql^Bsb\
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=20
                y=46
                terrain=Ql^Bsb\
            [/terrain]
        )}
        [redraw]
        [/redraw]
        [unlock_view]
        [/unlock_view]

        # scroll back
        {SCROLL_TO 61 43}
    [/event]

    # segment three
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=83,26
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL rune_three_active equals no}
        [/filter_condition]

        {SIMPLE_MSG unit ( _ "Huh, a rune?! Let me trigger it!")}

        # update rune
        {REMOVE_IMAGE 83 26}
        {PLACE_IMAGE "scenery/rune3-glow.png" 83 26}

        # update switch
        {VARIABLE rune_three_active yes}
        {REMOVE_IMAGE 84 28}
        {PLACE_IMAGE "scenery/rune4-glow.png" 84 28}
        {REMOVE_IMAGE 17 54}
        {PLACE_IMAGE "scenery/rune4-glow.png" 17 54}

        # scroll to
        {SCROLL_TO 21 38}
        [lock_view]
        [/lock_view]
        [remove_shroud]
            side=1
            x,y=21,38
            radius=3
        [/remove_shroud]
        [redraw]
        [/redraw]

        {THUNDER (
            [terrain]
                x=21,22
                y=39,39
                terrain=Ql^Bsb|
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=21,22
                y=40,40
                terrain=Ql^Bsb|
            [/terrain]
        )}
        [redraw]
        [/redraw]
        [unlock_view]
        [/unlock_view]

        # scroll back
        {SCROLL_TO 83 26}
    [/event]

    # segment four
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=83,42
        [/filter]

        [filter_condition]
            {VARIABLE_CONDITIONAL rune_four_active equals no}
        [/filter_condition]

        {SIMPLE_MSG unit ( _ "Huh, a rune?! Let me trigger it!")}

        # update rune
        {REMOVE_IMAGE 83 42}
        {PLACE_IMAGE "scenery/rune3-glow.png" 83 42}

        # update switch
        {VARIABLE rune_four_active yes}
        {REMOVE_IMAGE 84 39}
        {PLACE_IMAGE "scenery/rune4-glow.png" 84 39}
        {REMOVE_IMAGE 17 55}
        {PLACE_IMAGE "scenery/rune4-glow.png" 17 55}

        # scroll to
        {SCROLL_TO 23 50}
        [lock_view]
        [/lock_view]
        [remove_shroud]
            side=1
            x,y=23,37
            radius=3
        [/remove_shroud]
        [redraw]
        [/redraw]

        {THUNDER (
            [terrain]
                x=22,23
                y=37,38
                terrain=Ql^Bsb/
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=23,24
                y=37,37
                terrain=Ql^Bsb/
            [/terrain]
        )}
        {THUNDER (
            [terrain]
                x=25
                y=37
                terrain=Ql^Bsb/
            [/terrain]
        )}
        [redraw]
        [/redraw]
        [unlock_view]
        [/unlock_view]

        # scroll back
        {SCROLL_TO 83 42}
    [/event]

    # wyrm spawner
    [event]
        name=turn end
        first_time_only=no
        [filter_condition]
            [lua]
                #ifdef EASY
                code=<< return (wml.variables["turn_number"] % 7 == 0) >>
                #endif
                #ifdef NORMAL
                code=<< return (wml.variables["turn_number"] % 6 == 0) >>
                #endif
                #ifdef HARD
                code=<< return (wml.variables["turn_number"] % 4 == 0) >>
                #endif
            [/lua]
        [/filter_condition]

        {SCATTER_UNITS {ON_DIFFICULTY 11 14 17} "Cave Wyrm,Cave Wyrm,Cave Wyrmlet" 8 (
            x=1-46
            y=8-53
            terrain=Mv
        ) (side=12)}
    [/event]

    # fire guardian spawner
    [event]
        name=turn end
        first_time_only=no
        [filter_condition]
            [lua]
                #ifdef EASY
                code=<< return (wml.variables["turn_number"] % 6 == 0) >>
                #endif
                #ifdef NORMAL
                code=<< return (wml.variables["turn_number"] % 5 == 0) >>
                #endif
                #ifdef HARD
                code=<< return (wml.variables["turn_number"] % 4 == 0) >>
                #endif
            [/lua]
        [/filter_condition]

        # 75% Fire Guardian, 25% Fire Wraith
        {SCATTER_UNITS {ON_DIFFICULTY 11 14 17} "Fire Guardian, Fire Wraith, Fire Guardian,Fire Guardian" 8 (
            x=1-46
            y=8-53
            terrain=Ql*,Mv
        ) (side=12)}
    [/event]

    # if elenia dies,
    # elves hate you
    [event]
        name="last breath"
        [filter]
            id="Elenia"
        [/filter]

        {SIMPLE_MSG Elenia ( _ "Farewell, my beloved sister!")}
        {SIMPLE_MSG Eryssa ( _ "Noooo!")}
    [/event]

    [event]
        name="die"
        [filter]
            id="Elenia"
        [/filter]

        {VARIABLE eryssa_friendly no}

        {SIMPLE_MSG Eryssa ( _ "<i>(teary eyes)</i> My sister...taken from me...")}

        {SIMPLE_MSG Eryssa ( _ "Elves of the Lins-Elen, dispatch any foe you see! I don't care if it's a dwarf, human, drake or lizard!")}

        [modify_side]
            side=10
            team_name=lintair
        [/modify_side]
    [/event]

    # eryssa death event
    [event]
        name="last breath"
        [filter]
            id="Eryssa"
        [/filter]

        {VARIABLE eryssa_alive_check no}

        {SIMPLE_MSG Eryssa ( _ "The Lins-Elen must not perish!")}
    [/event]

    # clan withervein buffing
    [event]
        name=recruit,recall
        first_time_only=no
        # counts like 9 units here
        [filter]
            side=2
            type_adv_tree=Orcish Grunt,Orcish Archer,Goblin Spearman
        [/filter]

        [object]
            silent=yes
            duration=scenario
            [filter]
                x,y=$x1,$y1
            [/filter]

            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_WITHERVEIN}
                [/abilities]
            [/effect]
            [effect]
                apply_to=attack
                range=melee
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_POISON}
                    {WEAPON_SPECIAL_SLOW}
                [/set_specials]
            [/effect]
        [/object]
    [/event]
    [event]
        name=recruit,recall
        first_time_only=no
        # seperate script for the Assassin/slayer/nightblade
        [filter]
            side=2
            type_adv_tree=Orcish Assassin
        [/filter]

        [object]
            silent=yes
            duration=scenario
            [filter]
                x,y=$x1,$y1
            [/filter]

            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_WITHERVEIN}
                [/abilities]
            [/effect]
            [effect]
                apply_to=attack
                range=melee
                type=blade
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_POISON}
                    {WEAPON_SPECIAL_SLOW}
                [/set_specials]
            [/effect]
        [/object]
    [/event]

    # stalrag death
    [event]
        name="last breath"
        [filter]
            id="Stalrag"
        [/filter]

        {SIMPLE_MSG unit ( _ "Farewell, my old friend! It was great to have fought alongside a brother after all these years!")}

        {SIMPLE_MSG Hamel ( _ "Stalrag! No!")}
    [/event]

    [event]
        name="die"
        [filter]
            id="Stalrag"
        [/filter]

        # Aiglondur already sent him a message after the end of S8 so
        # Lord Hamel is already aware of what Karrag is or did
        {SIMPLE_MSG Hamel ( _ "Karrag...I won't forgive you...")}
    [/event]

    # more stalrag specifics
    [event]
        name="attacker hits"
        # filter left empty as he is can be attacked
        # by most sides
        [filter_second]
            id="Stalrag"
            formula="if(self.hitpoints <= self.max_hitpoints / 3, 1, 0)"
        [/filter_second]

        # Natus Dragneel quote lol
        {SIMPLE_MSG Stalrag ( _ "I am fired up now!")}

        [heal_unit]
            [filter]
                id="Stalrag"
            [/filter]
            amount={ON_DIFFICULTY 24 38 32}
            restore_statuses=yes
            animate=yes
        [/heal_unit]

        [object]
            id=stalrag_rage_buff
            silent=yes
            duration=forever
            [filter]
                id="Stalrag"
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    [leadership]
                        id=enraged_extra
                        name=_"enraged"
                        description= _ "This unit has been enraged. This unit will deal 25% bonus damage on both attack and defence."
                        cumulative=yes
                        special_note= _ "Deals 25% bonus damage."
                        affect_self=yes
                        value=25
                    [/leadership]
                [/abilities]
            [/effect]
        [/object]
    [/event]

    # hamel reinforcements
    [event]
        name=turn end
        first_time_only=no
        [filter_condition]
            [lua]
                #ifdef EASY
                code=<< return (wml.variables["turn_number"] % 6 == 0) >>
                #endif
                #ifdef NORMAL
                code=<< return (wml.variables["turn_number"] % 6 == 0) >>
                #endif
                #ifdef HARD
                code=<< return (wml.variables["turn_number"] % 8 == 0) >>
                #endif
            [/lua]
        [/filter_condition]

        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 3 66}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 3 66}
        {RANDOM_RECRUIT 3 ({KNALGAN_ALLIANCE_RECRUITS_LORD_HAMEL}) 3 66}
    [/event]

    # special cameo
    [event]
        name="turn 5"

        [unit]
            side=3
            id=Morvin
            name= _ "Morvin"
            # not White mage anymore
            type=Silver Mage
            gender=male
            x,y=3,66
            animate=no
            placement=map
            passable=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_ELITE}
                [object]
                    duration=scenario
                    [effect]
                        apply_to=attack
                        range=ranged
                        set_type=cold
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=3
            id=Thera
            name= _ "female^Thera"
            # not White mage anymore
            type=Silver Mage
            gender=female
            x,y=3,66
            animate=no
            placement=map
            passable=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_ELITE}
                [object]
                    duration=scenario
                    [effect]
                        apply_to=attack
                        range=ranged
                        set_type=cold
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [unit]
            side=3
            id=Ratheln
            name= _ "Ratheln"
            # not Arch Mage anymore
            type=Silver Mage
            gender=male
            x,y=3,66
            animate=no
            placement=map
            passable=yes
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_ELITE}
                [object]
                    duration=scenario
                    [effect]
                        apply_to=attack
                        range=ranged
                        set_type=cold
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        # Teleport them
        {SCROLL_TO 5 61}
        {TELEPORT_UNIT (id=Morvin) 5 61}

        {SCROLL_TO 10 62}
        {TELEPORT_UNIT (id=Thera) 10 62}

        {TELEPORT_UNIT (id=Ratheln) 8 61}

        {SIMPLE_MSG Morvin ( _ "Thera and Ratheln, we have made it!")}

        {SIMPLE_MSG Hamel ( _ "<i>(shocked)</i> Who the heck are you three?")}

        {SIMPLE_MSG Thera ( _ "We are silver mages...")}

        {SIMPLE_MSG Ratheln ( _ "...and we live in the Northlands too!")}

        {SIMPLE_MSG Morvin ( _ "Once we got wind of dwarves and humans mobilising to face this threat which has been plaguing the Northlands for decades now, we decided to come here and offer our services.")}

        {SIMPLE_MSG Tallin ( _ "Three silver mages...Boy, they'd be nice to have as allies in this fight.")}

        {SIMPLE_MSG Aiglondur ( _ "The decision is yours, uncle.")}

        {SIMPLE_MSG Hamel ( _ "Very well then. We fight for the North!")}
    [/event]

    # leaders join fights
    {LEADER_JOINS_BATTLE 4}

    # sighted events
    [event]
        name=sighted
        first_time_only=yes

        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [filter_second]
            side=1,2,3
        [/filter_second]

        {SIMPLE_MSG Ancatil ( _ "These dirtgrubbers must not allowed to advanced into the Citadel!")}

        {SIMPLE_MSG Angras ( _ "Hey, look! There's a glowing rune behind him. Might lead to somewhere worth investigating!")}

        {SIMPLE_MSG Zorfu ( _ "We need to dispatch that sentinel first though.")}
    [/event]

    # restore side 1 villages
    [event]
        name="capture"
        first_time_only=no
        [filter]
            side=2,3
        [/filter]

        # check if side 1 owns this village
        [filter_condition]
            {VARIABLE_CONDITIONAL owner_side numerical_equals 1}
        [/filter_condition]

        # return it back if true
        [capture_village]
            side=1
            x,y=$x1,$y1
        [/capture_village]
    [/event]

    # flavor
    {RENAME_MASKED_DWARVES 4,12}

    # some items
    {WITHERVEIN_POISON_POTION 25 65}
    {HEAL_POTION_BACKPACK 71 25}

    # phase 2 of the scenario
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            # no gryphon rider/master
            race=human,dwarf
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_11_stage equals "stageOne"}
        [/filter_condition]

        # update status
        {VARIABLE scenario_11_stage "stageTwo"}

        {THUNDER (
            [sound]
                name=dragon-roar.ogg
            [/sound]
            [delay]
                time=100
            [/delay]
        )}
        {THUNDER (
            [sound]
                name=dragon-roar.ogg
            [/sound]
            [delay]
                time=100
            [/delay]
        )}
        # flatter the floor
        {THUNDER (
            [terrain]
                terrain=Ias
                x=20,21,22,23,24,25,26
                y=17,18,18,19,18,18,17
            [/terrain]
        )}

        [redraw]
        [redraw]

        # spawn minor enemy units
        {RANDOM_RECRUIT 12 ("Drake Arbiter,Drake Thrasher") 18 21}
        {RANDOM_SPAWN 12 "Drake Clasher" 18 21}
        {RANDOM_SPAWN 12 "Drake Clasher" 18 21}
        {RANDOM_SPAWN 12 "Drake Clasher" 18 21}

        {RANDOM_RECRUIT 12 ("Drake Arbiter,Drake Thrasher") 31 22}
        {RANDOM_SPAWN 12 "Drake Clasher" 31 22}
        {RANDOM_SPAWN 12 "Drake Clasher" 31 22}
        {RANDOM_SPAWN 12 "Drake Clasher" 31 22}

        # masked dwarves
        {RANDOM_RECRUIT 12 "Dwarvish Masked Lord" 15 16}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 15 16}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 15 16}
        {RANDOM_SPAWN 12 ({KAL_KARTHA_MASKED_DWARVES_VETERANS}) 15 16}

        # clockwork units
        {RANDOM_RECRUIT 12 "Clockwork Armoured Golem" 34 16}
        {RANDOM_SPAWN 12 "Clockwork Golem" 34 16}
        {RANDOM_SPAWN 12 "Clockwork Golem" 34 16}
        {RANDOM_SPAWN 12 "Clockwork Golem" 34 16}

        {SCROLL_TO 23 16}
        # spawn the main stuff
        [unit]
            x,y=23,16
            side=11
            {CHARACTER_STATS_KERGEOM_ILLUSION}
        [/unit]

        {SIMPLE_MSG "Kergeom_Illusion" ( _ "What is this? Why are these insignificant creatures doing here in my keep?")}

        {SIMPLE_MSG "Karri Kon" ( _ "Ancestor, forgive our failure at stopping them in reaching you! We shall purge them for you.")}

        {SIMPLE_MSG "Kergeom_Illusion" ( _ "No matter...I am bored. Might as well incinerate them to ashes.")}
    [/event]

    # phase 2 specifics
    [event]
        name="attacker hits"
        first_time_only=yes

        # too many filters?
        [filter]
            id="Tallin"
        [/filter]
        [filter_attack]
            type=cold
        [/filter_attack]
        [filter_second]
            id="Kergeom_Illusion"
        [/filter_second]
        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_11_stage equals "stageTwo"}
        [/filter_condition]

        {GRIMOIRE_SHADOWS_MSG ( _ "Huh...a <i>fire</i> dragon being super resistant to cold? This is an anomaly.")}
        {SIMPLE_MSG "Tallin" ( _ "... a what?")}

        {GRIMOIRE_SHADOWS_MSG ( _ "Nevermind. Keep attacking it. Something might happen.")}
    [/event]

    # end phase 2 and move to phase 3
    [event]
        name="attacker hits"
        [filter_second]
            id="Kergeom_Illusion"
            formula="if(self.hitpoints <= self.max_hitpoints / 5, 1, 0)"
        [/filter_second]
        [filter_condition]
            {VARIABLE_CONDITIONAL scenario_11_stage equals "stageTwo"}
        [/filter_condition]

        {SIMPLE_MSG "Angras" ( _ "I feel some runic magic at work here!")}

        {SIMPLE_MSG "Aiglondur" ( _ "Brace yourselves! This battle isn't over!")}

        {SIMPLE_MSG "Tallin" ( _ "I don't like the looks of this!")}

        ## begin stage 3 code here
    [/event]

    # Setting: Now volcanic peak of Gom Thurim
    # Fight Kergeom in huge battle

    {HERO_DEATH_EVENTS_ALL}
[/scenario]
